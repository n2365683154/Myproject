# 本地修改到服务器部署完整流程

## 📋 完整流程概览

```
本地修改 → Git提交 → Git推送 → 服务器拉取 → 重新构建 → 部署完成
```

---

## 🔧 步骤1：本地修改后端文件

### 1.1 修改需要的文件

例如修改密码验证逻辑，创建 `backend/app/core/security.py`：

**在本地 Windows 项目目录**：`C:\Users\Administrator\CascadeProjects\考试系统`

创建或修改文件：`backend\app\core\security.py`

```python
from passlib.context import CryptContext

# 简化的密码上下文，使用 pbkdf2_sha256 代替 bcrypt
pwd_context = CryptContext(schemes=["pbkdf2_sha256"], deprecated="auto")

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """验证密码"""
    try:
        return pwd_context.verify(plain_password, hashed_password)
    except:
        # 如果哈希验证失败，尝试明文比较（兼容旧数据）
        return plain_password == hashed_password

def get_password_hash(password: str) -> str:
    """生成密码哈希"""
    return pwd_context.hash(password)
```

### 1.2 修改相关引用

如果需要，修改 `backend/app/main.py` 中的导入：

```python
from app.core.security import get_password_hash, verify_password
```

---

## 📤 步骤2：提交到 Git

### 2.1 查看修改内容

在本地 PowerShell 或命令提示符中：

```powershell
# 进入项目目录
cd C:\Users\Administrator\CascadeProjects\考试系统

# 查看修改了哪些文件
git status

# 查看具体修改内容
git diff
```

### 2.2 添加修改到暂存区

```powershell
# 添加所有修改
git add .

# 或者只添加特定文件
git add backend/app/core/security.py
git add backend/app/main.py
```

### 2.3 提交到本地仓库

```powershell
# 提交并写清楚修改说明
git commit -m "fix: 修复bcrypt密码验证问题，使用pbkdf2_sha256替代

- 创建 backend/app/core/security.py 统一密码处理
- 使用 pbkdf2_sha256 避免 bcrypt 版本冲突
- 支持明文密码兼容（临时方案）
- 修复初始化管理员账号失败的问题"
```

### 2.4 推送到远程仓库

```powershell
# 推送到 GitHub
git push origin main

# 如果遇到网络问题，多试几次
```

---

## 📥 步骤3：服务器拉取最新代码

### 3.1 SSH 连接服务器

```bash
ssh root@150.242.81.138
```

### 3.2 进入项目目录

```bash
cd /www/wwwroot/exam_system
```

### 3.3 拉取最新代码

```bash
# 查看当前状态
git status

# 拉取最新代码
git pull origin main

# 如果有本地修改冲突，强制更新
git fetch origin
git reset --hard origin/main

# 验证代码已更新
git log -1
```

---

## 🔨 步骤4：重新构建并部署

### 4.1 停止现有服务

```bash
docker-compose -f docker-compose.prod.yml down
```

### 4.2 重新构建后端镜像

```bash
# 重新构建后端（不使用缓存，确保使用最新代码）
docker-compose -f docker-compose.prod.yml build --no-cache backend

# 或者重新构建所有服务
docker-compose -f docker-compose.prod.yml build --no-cache
```

### 4.3 启动服务

```bash
docker-compose -f docker-compose.prod.yml up -d
```

### 4.4 查看启动日志

```bash
# 查看后端日志
docker-compose -f docker-compose.prod.yml logs -f backend

# 按 Ctrl+C 退出日志查看

# 或者查看最近的日志
docker-compose -f docker-compose.prod.yml logs --tail=50 backend
```

---

## ✅ 步骤5：验证部署

### 5.1 检查容器状态

```bash
docker-compose -f docker-compose.prod.yml ps
```

应该看到所有容器状态为 `Up`。

### 5.2 检查后端日志

```bash
docker logs exam_backend | tail -20
```

应该没有错误信息。

### 5.3 测试访问

1. **访问前端**：http://150.242.81.138:18080
2. **访问API文档**：http://150.242.81.138:18000/api/docs
3. **测试登录**：
   - 用户名：`admin`
   - 密码：`admin123`

---

## 🎯 完整命令速查（复制执行）

### 本地操作（Windows PowerShell）

```powershell
cd C:\Users\Administrator\CascadeProjects\考试系统

# 查看修改
git status
git diff

# 提交修改
git add .
git commit -m "fix: 修复后端问题"
git push origin main
```

### 服务器操作（SSH）

```bash
# 连接服务器
ssh root@150.242.81.138

# 进入项目
cd /www/wwwroot/exam_system

# 更新代码
git pull origin main

# 重新部署
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml build --no-cache backend
docker-compose -f docker-compose.prod.yml up -d

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f backend
```

---

## 🔍 常见问题处理

### 问题1：Git 推送失败

```powershell
# 检查远程仓库
git remote -v

# 设置代理（如果网络问题）
git config --global http.proxy http://127.0.0.1:7890
git config --global https.proxy http://127.0.0.1:7890

# 取消代理
git config --global --unset http.proxy
git config --global --unset https.proxy
```

### 问题2：服务器 Git 拉取失败

```bash
# 查看远程分支
git remote -v

# 强制重置到远程最新
git fetch origin
git reset --hard origin/main

# 清理未跟踪的文件
git clean -fd
```

### 问题3：Docker 构建失败

```bash
# 查看详细错误
docker-compose -f docker-compose.prod.yml build backend

# 清理 Docker 缓存
docker system prune -af

# 重新构建
docker-compose -f docker-compose.prod.yml build --no-cache --pull backend
```

### 问题4：容器启动后立即退出

```bash
# 查看容器日志
docker logs exam_backend

# 查看详细错误
docker-compose -f docker-compose.prod.yml logs backend

# 进入容器排查（如果容器在运行）
docker exec -it exam_backend bash
```

---

## 📝 最佳实践

### 1. 提交前检查

```powershell
# 确保代码没有语法错误
# 确保修改的逻辑正确
# 写清楚提交信息
```

### 2. 分阶段提交

```powershell
# 每次只修改一个功能
# 不要把多个不相关的修改放在一起提交
# 提交信息要清晰描述修改内容
```

### 3. 部署前备份

```bash
# 在服务器上执行
cd /www/wwwroot/exam_system
docker exec exam_mysql mysqldump -u root -pexamroot system > backup_before_update.sql
```

### 4. 增量更新

```bash
# 如果只修改了后端，只重建后端
docker-compose -f docker-compose.prod.yml build --no-cache backend

# 如果只修改了前端，只重建前端
docker-compose -f docker-compose.prod.yml build --no-cache frontend
```

---

## 🎓 Git 提交信息规范

```
feat:     新功能
fix:      修复Bug
docs:     文档更新
style:    代码格式（不影响功能）
refactor: 重构（不是新功能也不是修复）
perf:     性能优化
test:     测试相关
chore:    构建工具或辅助工具的变动
```

**示例**：

```bash
git commit -m "feat: 添加用户权限管理功能"
git commit -m "fix: 修复多选题判分逻辑错误"
git commit -m "refactor: 重构密码验证模块"
```

---

## ⏱️ 典型部署时间

| 步骤 | 预计时间 |
|------|----------|
| Git 推送 | 10-30秒 |
| 服务器拉取 | 5-10秒 |
| Docker 构建 | 2-5分钟 |
| 容器启动 | 30-60秒 |
| **总计** | **3-7分钟** |

---

## 💡 提示

1. **修改前**：先在本地测试确保代码正确
2. **提交时**：写清楚提交信息方便回溯
3. **部署前**：备份数据库防止意外
4. **部署后**：检查日志确保没有错误
5. **测试**：访问系统确保功能正常

---

**按照这个流程，您的修改就能安全地从本地部署到服务器了！** 🎉
