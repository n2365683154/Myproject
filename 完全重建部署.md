# å®Œå…¨é‡å»ºéƒ¨ç½²æŒ‡å—

> ç”¨äºè§£å†³ bcrypt é”™è¯¯å’Œæ•°æ®åº“æ­»é”é—®é¢˜

## ğŸ¯ é—®é¢˜è¯´æ˜

å½“é‡åˆ°ä»¥ä¸‹é”™è¯¯æ—¶ä½¿ç”¨æ­¤æŒ‡å—ï¼š
1. `(trapped) error reading bcrypt version`
2. `password cannot be longer than 72 bytes`
3. `Deadlock found when trying to get lock`

## ğŸš€ å®Œå…¨é‡å»ºæ­¥éª¤ï¼ˆæœåŠ¡å™¨ç«¯æ‰§è¡Œï¼‰

### ç¬¬1æ­¥ï¼šSSH è¿æ¥æœåŠ¡å™¨

```bash
ssh root@150.242.81.138
cd /www/wwwroot/exam_system
```

### ç¬¬2æ­¥ï¼šæ‹‰å–æœ€æ–°ä»£ç 

```bash
# æ‹‰å–æœ€æ–°ä¿®å¤ä»£ç 
git pull origin main

# å¦‚æœå¤±è´¥ï¼Œå¼ºåˆ¶æ›´æ–°
git fetch origin
git reset --hard origin/main
```

### ç¬¬3æ­¥ï¼šå®Œå…¨åœæ­¢å¹¶æ¸…ç†

```bash
# åœæ­¢æ‰€æœ‰å®¹å™¨
docker-compose -f docker-compose.prod.yml down

# æ¸…ç†æ‰€æœ‰å®¹å™¨ã€ç½‘ç»œã€æ•°æ®å·ï¼ˆä¼šåˆ é™¤æ•°æ®åº“æ•°æ®ï¼ï¼‰
docker-compose -f docker-compose.prod.yml down -v

# æ¸…ç†Dockerç³»ç»Ÿç¼“å­˜ï¼ˆé‡è¦ï¼ç¡®ä¿ä¸ä½¿ç”¨æ—§é•œåƒï¼‰
docker system prune -af --volumes
```

### ç¬¬4æ­¥ï¼šé‡æ–°æ„å»ºé•œåƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰

```bash
# å¼ºåˆ¶é‡æ–°æ„å»ºï¼Œç¡®ä¿ä»£ç æ›´æ–°
docker-compose -f docker-compose.prod.yml build --no-cache --pull
```

### ç¬¬5æ­¥ï¼šå¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d
```

### ç¬¬6æ­¥ï¼šæŸ¥çœ‹æ—¥å¿—éªŒè¯

```bash
# å®æ—¶æŸ¥çœ‹åç«¯æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend

# åº”è¯¥çœ‹åˆ°ï¼š
# âœ“ Redisè¿æ¥æˆåŠŸ
# âœ“ å¼€å§‹åˆå§‹åŒ–é»˜è®¤æ•°æ®...
# âœ“ å·²åˆ›å»º XX ä¸ªæƒé™
# âœ“ å·²åˆ›å»º 2 ä¸ªè§’è‰²
# âœ“ é»˜è®¤æ•°æ®åˆå§‹åŒ–å®Œæˆ
# âœ“ é»˜è®¤ç®¡ç†å‘˜è´¦å·: admin / admin123
# âœ“ æ¥šç„¶æ™ºè€ƒç³»ç»Ÿå¯åŠ¨å®Œæˆ

# æŒ‰ Ctrl+C é€€å‡ºæ—¥å¿—æŸ¥çœ‹
```

### ç¬¬7æ­¥ï¼šéªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# åº”è¯¥çœ‹åˆ°4ä¸ªå®¹å™¨éƒ½æ˜¯ Up çŠ¶æ€
```

---

## âœ… è®¿é—®æµ‹è¯•

è®¿é—®ç³»ç»Ÿï¼š
- **å‰ç«¯**: http://150.242.81.138:18080
- **åç«¯API**: http://150.242.81.138:18000/api/docs

ç™»å½•æµ‹è¯•ï¼š
- ç”¨æˆ·åï¼š`admin`
- å¯†ç ï¼š`admin123`

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœä»æœ‰ bcrypt é”™è¯¯

è¯´æ˜Dockerä½¿ç”¨äº†ç¼“å­˜çš„æ—§é•œåƒï¼Œæ‰§è¡Œï¼š

```bash
# åˆ é™¤æ‰€æœ‰ç›¸å…³é•œåƒ
docker rmi $(docker images 'exam_*' -q) -f

# é‡æ–°æ„å»º
docker-compose -f docker-compose.prod.yml build --no-cache --pull

# å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d
```

### å¦‚æœæ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æŸ¥çœ‹MySQLå®¹å™¨
docker logs exam_mysql --tail=50

# é‡å¯MySQL
docker-compose -f docker-compose.prod.yml restart mysql

# ç­‰å¾…30ç§’
sleep 30

# é‡å¯åç«¯
docker-compose -f docker-compose.prod.yml restart backend
```

### å¦‚æœåˆå§‹åŒ–ä»ç„¶å¤±è´¥

æ‰‹åŠ¨åœ¨å®¹å™¨ä¸­åˆå§‹åŒ–ï¼š

```bash
# è¿›å…¥åç«¯å®¹å™¨
docker exec -it exam_backend bash

# æ¸…ç©ºæ•°æ®åº“è¡¨
python -c "
from app.database import SessionLocal, engine
from app.models.user import Base

db = SessionLocal()
Base.metadata.drop_all(bind=engine)
Base.metadata.create_all(bind=engine)
db.close()
print('æ•°æ®åº“è¡¨å·²é‡ç½®')
"

# é€€å‡ºå®¹å™¨
exit

# é‡å¯åç«¯è®©å®ƒè‡ªåŠ¨åˆå§‹åŒ–
docker-compose -f docker-compose.prod.yml restart backend

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
```

---

## ğŸ“Š é¢„æœŸæ—¥å¿—è¾“å‡º

**æ­£ç¡®çš„å¯åŠ¨æ—¥å¿—åº”è¯¥æ˜¯ï¼š**

```
exam_backend  | æ¥šç„¶æ™ºè€ƒç³»ç»Ÿå¯åŠ¨ä¸­...
exam_backend  | æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
exam_backend  | Redisè¿æ¥æˆåŠŸ
exam_backend  | å¼€å§‹åˆå§‹åŒ–é»˜è®¤æ•°æ®...
exam_backend  | å·²åˆ›å»º XX ä¸ªæƒé™
exam_backend  | å·²åˆ›å»º 2 ä¸ªè§’è‰²
exam_backend  | âœ“ é»˜è®¤æ•°æ®åˆå§‹åŒ–å®Œæˆ
exam_backend  | âœ“ é»˜è®¤ç®¡ç†å‘˜è´¦å·: admin / admin123
exam_backend  | æ¥šç„¶æ™ºè€ƒç³»ç»Ÿå¯åŠ¨å®Œæˆ
exam_backend  | Application startup complete.
```

**ä¸åº”è¯¥å‡ºç°çš„é”™è¯¯ï¼š**
- âŒ `(trapped) error reading bcrypt version`
- âŒ `password cannot be longer than 72 bytes`
- âŒ `Deadlock found when trying to get lock`
- âŒ `åˆå§‹åŒ–é»˜è®¤æ•°æ®å¤±è´¥`

---

## ğŸ‰ å®Œæˆç¡®è®¤æ¸…å•

éƒ¨ç½²æˆåŠŸåï¼Œæ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] 4ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œï¼ˆfrontend, backend, mysql, redisï¼‰
- [ ] åç«¯æ—¥å¿—æ²¡æœ‰é”™è¯¯
- [ ] å‰ç«¯é¡µé¢å¯ä»¥è®¿é—®
- [ ] å¯ä»¥ä½¿ç”¨ admin/admin123 ç™»å½•
- [ ] APIæ–‡æ¡£å¯ä»¥è®¿é—®
- [ ] éªŒè¯ç æ­£å¸¸æ˜¾ç¤º

---

## ğŸ’¾ å¤‡ä»½æç¤º

å¦‚æœéœ€è¦ä¿ç•™æ•°æ®ï¼Œåœ¨ç¬¬3æ­¥ä¹‹å‰æ‰§è¡Œï¼š

```bash
# å¤‡ä»½æ•°æ®åº“
docker exec exam_mysql mysqldump -u root -pexamroot system > backup_before_rebuild.sql

# æ¢å¤æ•°æ®ï¼ˆé‡å»ºåï¼‰
docker exec -i exam_mysql mysql -u root -pexamroot system < backup_before_rebuild.sql
```

---

## ğŸ”„ å¿«é€Ÿé‡å»ºå‘½ä»¤ï¼ˆä¸€é”®æ‰§è¡Œï¼‰

```bash
cd /www/wwwroot/exam_system && \
git pull origin main && \
docker-compose -f docker-compose.prod.yml down -v && \
docker system prune -af --volumes && \
docker-compose -f docker-compose.prod.yml build --no-cache --pull && \
docker-compose -f docker-compose.prod.yml up -d && \
sleep 10 && \
docker-compose -f docker-compose.prod.yml logs --tail=50 backend
```

---

**æ‰§è¡Œå®Œæˆåï¼Œç³»ç»Ÿåº”è¯¥å®Œå…¨æ­£å¸¸è¿è¡Œï¼** ğŸ‰
