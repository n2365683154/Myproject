# å®å¡”é¢æ¿ Docker éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²ç¯å¢ƒ

- **æœåŠ¡å™¨**: Debian 14
- **é¢æ¿**: å®å¡”é¢æ¿
- **æœåŠ¡å™¨IP**: 150.242.81.138
- **é¡¹ç›®è·¯å¾„**: `/www/wwwroot/exam_system`

## ğŸ”§ ç«¯å£é…ç½®

| æœåŠ¡ | å®¹å™¨ç«¯å£ | æ˜ å°„ç«¯å£ |
|------|----------|----------|
| å‰ç«¯ | 80 | 18080 |
| åç«¯ | 8000 | 18000 |
| MySQL | 3306 | 13306 |
| Redis | 6379 | 16379 |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬1æ­¥ï¼šåœ¨å®å¡”é¢æ¿å®‰è£… Docker

1. ç™»å½•å®å¡”é¢æ¿ï¼š`http://150.242.81.138:å®å¡”ç«¯å£`
2. è¿›å…¥ **è½¯ä»¶å•†åº—**
3. æœç´¢ **Docker**ï¼Œç‚¹å‡»å®‰è£…
4. å®‰è£… **Docker Compose**ï¼ˆå¦‚æœæ²¡æœ‰è‡ªåŠ¨å®‰è£…ï¼‰

æˆ–è€…é€šè¿‡å‘½ä»¤è¡Œå®‰è£…ï¼š

```bash
# SSH è¿æ¥åˆ°æœåŠ¡å™¨
ssh root@150.242.81.138

# å®‰è£… Docker
curl -fsSL https://get.docker.com | bash

# å®‰è£… Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### ç¬¬2æ­¥ï¼šåœ¨å®å¡”é¢æ¿å¼€æ”¾ç«¯å£

1. è¿›å…¥å®å¡”é¢æ¿ â†’ **å®‰å…¨**
2. æ·»åŠ ä»¥ä¸‹ç«¯å£è§„åˆ™ï¼š

```
18080  # å‰ç«¯è®¿é—®ç«¯å£
18000  # åç«¯APIç«¯å£
13306  # MySQLç«¯å£ï¼ˆå¯é€‰ï¼Œå¦‚éœ€å¤–éƒ¨è®¿é—®ï¼‰
16379  # Redisç«¯å£ï¼ˆå¯é€‰ï¼Œå¦‚éœ€å¤–éƒ¨è®¿é—®ï¼‰
```

### ç¬¬3æ­¥ï¼šå‡†å¤‡é¡¹ç›®æ–‡ä»¶

```bash
# SSH è¿æ¥æœåŠ¡å™¨
ssh root@150.242.81.138

# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /www/wwwroot/exam_system
cd /www/wwwroot/exam_system

# å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœå·²æœ‰ä»£ç ï¼Œè·³è¿‡æ­¤æ­¥ï¼‰
git clone https://github.com/n2365683154/Myproject.git .

# æˆ–è€…ä½¿ç”¨å®å¡”é¢æ¿çš„æ–‡ä»¶ç®¡ç†ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
```

### ç¬¬4æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
cd /www/wwwroot/exam_system

# å¤åˆ¶ç¯å¢ƒé…ç½®
cp .env.example .env

# ç¼–è¾‘é…ç½®ï¼ˆå¯ä»¥ä½¿ç”¨å®å¡”é¢æ¿çš„æ–‡ä»¶ç¼–è¾‘å™¨ï¼‰
nano .env
```

`.env` é…ç½®å†…å®¹ï¼š

```env
# æ•°æ®åº“é…ç½®
MYSQL_ROOT_PASSWORD=examroot
MYSQL_DATABASE=system
MYSQL_USER=system
MYSQL_PASSWORD=examroot
MYSQL_PORT=13306

# Redis é…ç½®
REDIS_PORT=16379

# åº”ç”¨ç«¯å£
BACKEND_PORT=18000
FRONTEND_PORT=18080

# JWT å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼ï¼‰
SECRET_KEY=abiao19980301567xningshunchuailuoran

# è·¨åŸŸé…ç½®
ALLOWED_ORIGINS=http://150.242.81.138:18080

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=INFO
```

### ç¬¬5æ­¥ï¼šæ‰§è¡Œéƒ¨ç½²

#### æ–¹å¼1ï¼šä½¿ç”¨å®å¡”Dockerç®¡ç†å™¨ï¼ˆæ¨èæ–°æ‰‹ï¼‰

1. è¿›å…¥å®å¡”é¢æ¿ â†’ **Docker**
2. ç‚¹å‡» **é•œåƒç®¡ç†**
3. å¯¼å…¥ `docker-compose.prod.yml`
4. ç‚¹å‡» **å¯åŠ¨**

#### æ–¹å¼2ï¼šä½¿ç”¨å‘½ä»¤è¡Œï¼ˆæ¨èï¼‰

```bash
cd /www/wwwroot/exam_system

# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/*.sh

# æ‰§è¡Œæ¶æ„é‡æ„ï¼ˆé¦–æ¬¡éƒ¨ç½²å¿…é¡»ï¼‰
./scripts/refactor.sh

# ä½¿ç”¨å®å¡”éƒ¨ç½²è„šæœ¬
./scripts/deploy-baota.sh
```

#### æ–¹å¼3ï¼šæ‰‹åŠ¨éƒ¨ç½²

```bash
cd /www/wwwroot/exam_system

# åœæ­¢å¹¶æ¸…ç†æ—§å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
docker-compose -f docker-compose.prod.yml down -v

# æ¸…ç†æ—§é•œåƒ
docker system prune -af

# æ„å»ºé•œåƒ
docker-compose -f docker-compose.prod.yml build --no-cache

# å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d

# æŸ¥çœ‹çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f
```

### ç¬¬6æ­¥ï¼šåˆå§‹åŒ–ç³»ç»Ÿ

```bash
# ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆçº¦30ç§’ï¼‰
sleep 30

# åˆ›å»ºç®¡ç†å‘˜è´¦å·
./scripts/manage.sh admin

# ä¿®å¤éªŒè¯é€»è¾‘
./scripts/manage.sh fix-auth

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
./scripts/manage.sh status
```

### ç¬¬7æ­¥ï¼šéªŒè¯éƒ¨ç½²

1. **è®¿é—®å‰ç«¯**ï¼šhttp://150.242.81.138:18080
2. **è®¿é—®åç«¯APIæ–‡æ¡£**ï¼šhttp://150.242.81.138:18000/api/docs
3. **ç™»å½•ç³»ç»Ÿ**ï¼š
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`admin123`

---

## ğŸ¯ å®å¡”é¢æ¿ç‰¹æ®Šé…ç½®

### 1. é…ç½®åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰

å¦‚æœæƒ³é€šè¿‡åŸŸåè®¿é—®ï¼Œåœ¨å®å¡”é¢æ¿é…ç½®åå‘ä»£ç†ï¼š

1. å®å¡”é¢æ¿ â†’ **ç½‘ç«™** â†’ **æ·»åŠ ç«™ç‚¹**
2. åŸŸåå¡«å†™ï¼š`exam.yourdomain.com`
3. åˆ›å»ºåï¼Œç‚¹å‡» **è®¾ç½®** â†’ **åå‘ä»£ç†**
4. æ·»åŠ åå‘ä»£ç†ï¼š
   - ä»£ç†åç§°ï¼š`è€ƒè¯•ç³»ç»Ÿå‰ç«¯`
   - ç›®æ ‡URLï¼š`http://127.0.0.1:18080`
   - å‘é€åŸŸåï¼š`$host`

5. å†æ·»åŠ ä¸€ä¸ªAPIä»£ç†ï¼š
   - ä»£ç†åç§°ï¼š`è€ƒè¯•ç³»ç»ŸAPI`
   - ç›®æ ‡URLï¼š`http://127.0.0.1:18000`
   - é…ç½®è·¯å¾„ï¼š`/api`

### 2. é…ç½® SSL è¯ä¹¦ï¼ˆå¯é€‰ï¼‰

1. å®å¡”é¢æ¿ â†’ ç½‘ç«™ â†’ SSL
2. é€‰æ‹© **Let's Encrypt** å…è´¹è¯ä¹¦
3. ç‚¹å‡»ç”³è¯·
4. å¼€å¯ **å¼ºåˆ¶HTTPS**

### 3. åœ¨å®å¡”é¢æ¿æŸ¥çœ‹å®¹å™¨

1. å®å¡”é¢æ¿ â†’ **Docker** â†’ **å®¹å™¨åˆ—è¡¨**
2. å¯ä»¥çœ‹åˆ° 4 ä¸ªå®¹å™¨ï¼š
   - `exam_frontend`
   - `exam_backend`
   - `exam_mysql`
   - `exam_redis`

3. å¯ä»¥ç›´æ¥åœ¨é¢æ¿ä¸Šï¼š
   - å¯åŠ¨/åœæ­¢/é‡å¯å®¹å™¨
   - æŸ¥çœ‹æ—¥å¿—
   - è¿›å…¥ç»ˆç«¯

---

## ğŸ”§ å¸¸ç”¨ç»´æŠ¤æ“ä½œ

### é€šè¿‡å®å¡”é¢æ¿æ“ä½œ

#### æŸ¥çœ‹å®¹å™¨æ—¥å¿—
1. Docker â†’ å®¹å™¨åˆ—è¡¨
2. ç‚¹å‡»å®¹å™¨åç§°
3. é€‰æ‹© **æ—¥å¿—**

#### é‡å¯å®¹å™¨
1. Docker â†’ å®¹å™¨åˆ—è¡¨
2. å‹¾é€‰å®¹å™¨
3. ç‚¹å‡» **é‡å¯**

#### è¿›å…¥å®¹å™¨ç»ˆç«¯
1. Docker â†’ å®¹å™¨åˆ—è¡¨
2. ç‚¹å‡»å®¹å™¨åç§°
3. é€‰æ‹© **ç»ˆç«¯**

### é€šè¿‡å‘½ä»¤è¡Œæ“ä½œ

```bash
cd /www/wwwroot/exam_system

# æŸ¥çœ‹çŠ¶æ€
./scripts/manage.sh status

# æŸ¥çœ‹æ—¥å¿—
./scripts/manage.sh logs backend
./scripts/manage.sh logs frontend

# é‡å¯æœåŠ¡
./scripts/manage.sh restart

# å¤‡ä»½æ•°æ®
./scripts/manage.sh backup

# æ›´æ–°ä»£ç åé‡å»º
git pull
./scripts/manage.sh rebuild
```

---

## ğŸ“Š ç›‘æ§ä¸å¤‡ä»½

### 1. è®¾ç½®è‡ªåŠ¨å¤‡ä»½

åœ¨å®å¡”é¢æ¿ â†’ **è®¡åˆ’ä»»åŠ¡** ä¸­æ·»åŠ ï¼š

**ä»»åŠ¡ç±»å‹**ï¼šShellè„šæœ¬

**ä»»åŠ¡åç§°**ï¼šè€ƒè¯•ç³»ç»Ÿæ•°æ®åº“å¤‡ä»½

**æ‰§è¡Œå‘¨æœŸ**ï¼šæ¯å¤© 3:00

**è„šæœ¬å†…å®¹**ï¼š
```bash
#!/bin/bash
cd /www/wwwroot/exam_system
./scripts/manage.sh backup

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find /www/wwwroot/exam_system -name "exam_backup_*.sql" -mtime +7 -delete
```

### 2. è®¾ç½®ç›‘æ§å‘Šè­¦

åœ¨å®å¡”é¢æ¿ â†’ **ç›‘æ§** ä¸­é…ç½®ï¼š

- CPUä½¿ç”¨ç‡å‘Šè­¦ï¼š> 80%
- å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦ï¼š> 85%
- ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦ï¼š> 90%
- Dockerå®¹å™¨çŠ¶æ€ç›‘æ§

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šå®¹å™¨å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
docker-compose -f docker-compose.prod.yml logs

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep -E "18080|18000|13306|16379"

# å¦‚æœç«¯å£è¢«å ç”¨ï¼Œä¿®æ”¹ .env ä¸­çš„ç«¯å£é…ç½®
```

### é—®é¢˜2ï¼šè®¿é—®ä¸äº†å‰ç«¯

1. æ£€æŸ¥å®å¡”å®‰å…¨è§„åˆ™æ˜¯å¦å¼€æ”¾ 18080 ç«¯å£
2. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™ï¼š
```bash
firewall-cmd --list-ports
firewall-cmd --add-port=18080/tcp --permanent
firewall-cmd --reload
```

### é—®é¢˜3ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# è¿›å…¥MySQLå®¹å™¨
docker exec -it exam_mysql bash

# ç™»å½•MySQL
mysql -uroot -pexamroot

# æ£€æŸ¥æ•°æ®åº“
SHOW DATABASES;
USE system;
SHOW TABLES;
```

### é—®é¢˜4ï¼šå®å¡”é¢æ¿çœ‹ä¸åˆ°å®¹å™¨

```bash
# é‡å¯DockeræœåŠ¡
systemctl restart docker

# åˆ·æ–°å®å¡”Dockeræ’ä»¶
# åœ¨å®å¡”é¢æ¿ â†’ Docker â†’ ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®
```

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

```bash
# ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ï¼ˆç³»ç»Ÿå†…æ“ä½œï¼‰
# ç™»å½•ååœ¨ ä¸ªäººä¸­å¿ƒ â†’ ä¿®æ”¹å¯†ç 

# ä¿®æ”¹æ•°æ®åº“å¯†ç 
docker exec -it exam_mysql mysql -uroot -pexamroot
ALTER USER 'root'@'%' IDENTIFIED BY 'æ–°å¯†ç ';
FLUSH PRIVILEGES;

# åŒæ­¥ä¿®æ”¹ .env æ–‡ä»¶ä¸­çš„å¯†ç 
```

### 2. é…ç½®é˜²ç«å¢™è§„åˆ™

åªå¼€æ”¾å¿…è¦çš„ç«¯å£ï¼š
- 18080 (å‰ç«¯)
- 18000 (åç«¯API)
- 22 (SSH - é™åˆ¶IP)
- å®å¡”é¢æ¿ç«¯å£ (é™åˆ¶IP)

ä¸è¦å¼€æ”¾ï¼š
- 13306 (MySQL) - ä»…å®¹å™¨å†…éƒ¨è®¿é—®
- 16379 (Redis) - ä»…å®¹å™¨å†…éƒ¨è®¿é—®

### 3. å®šæœŸæ›´æ–°

```bash
# æ¯å‘¨æ‰§è¡Œä¸€æ¬¡
cd /www/wwwroot/exam_system
git pull
./scripts/manage.sh rebuild
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ—¥å¿—ä½ç½®

- å®å¡”é¢æ¿æ—¥å¿—ï¼š`/www/server/panel/logs/`
- Dockeræ—¥å¿—ï¼šé€šè¿‡ `docker logs å®¹å™¨å` æŸ¥çœ‹
- åº”ç”¨æ—¥å¿—ï¼šå®¹å™¨å†… `/app/logs/`

### å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/exam_system

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker ps -a

# æŸ¥çœ‹èµ„æºå ç”¨
docker stats

# æ¸…ç†æ— ç”¨èµ„æº
docker system prune -af

# å¯¼å‡ºæ•°æ®åº“
docker exec exam_mysql mysqldump -u root -pexamroot system > backup.sql

# å¯¼å…¥æ•°æ®åº“
docker exec -i exam_mysql mysql -u root -pexamroot system < backup.sql
```

---

## âœ… éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œè¯·é€é¡¹æ£€æŸ¥ï¼š

- [ ] æ‰€æœ‰4ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œï¼ˆfrontendã€backendã€mysqlã€redisï¼‰
- [ ] å‰ç«¯é¡µé¢å¯ä»¥æ­£å¸¸è®¿é—® (http://150.242.81.138:18080)
- [ ] åç«¯APIæ–‡æ¡£å¯ä»¥è®¿é—® (http://150.242.81.138:18000/api/docs)
- [ ] å¯ä»¥ä½¿ç”¨ admin/admin123 ç™»å½•
- [ ] éªŒè¯ç æ­£å¸¸æ˜¾ç¤º
- [ ] å¯ä»¥åˆ›å»ºé¢˜ç›®
- [ ] å¯ä»¥åˆ›å»ºè€ƒè¯•
- [ ] ç»ƒä¹ æ¨¡å¼åˆ¤é¢˜æ­£ç¡®
- [ ] å®å¡”é¢æ¿å¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¹å™¨
- [ ] å·²è®¾ç½®è‡ªåŠ¨å¤‡ä»½è®¡åˆ’ä»»åŠ¡
- [ ] å·²ä¿®æ”¹é»˜è®¤å¯†ç 

---

**éƒ¨ç½²å®Œæˆï¼ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ•…éšœæ’æŸ¥éƒ¨åˆ†æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚
